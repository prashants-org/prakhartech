name: Dev CI & Auto-Merge

on:
  push:
    branches: [dev]

permissions:
  contents: write # Needed to merge code
  issues: write # Needed to create/close issues

jobs:
  test-and-manage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for merging

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # 1. Run Tests and pipe output to a file (so we can put it in the issue)
      - name: Run Tests
        id: run-tests
        run: |
          npm run test:unit > test_log.txt 2>&1
          npm run test:e2e >> test_log.txt 2>&1
        continue-on-error: true # Don't stop yet, we need to handle the failure logic

      # CASE 1: FAILURE -> Create Issue
      - name: Create Issue on Failure
        if: steps.run-tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const log = fs.readFileSync('test_log.txt', 'utf8');

            // Create the issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `CI Failed on Dev: ${context.sha.substring(0, 7)}`,
              body: `### Test Failures Detected\n\nCommit: ${context.sha}\n\n\`\`\`\n${log.slice(-3000)}\n\`\`\`\n\n[View Full Logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['ci-fail', 'automated']
            });

            // Fail the job strictly now
            core.setFailed('Tests failed. Issue created.');

      # CASE 2b: SUCCESS -> Find and Close previous Issue
      - name: Close Previous Fail Issues
        if: steps.run-tests.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-fail'
            });

            if (issues.data.length > 0) {
              for (const issue of issues.data) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'completed'
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `Fixed in commit ${context.sha}. Tests passed!`
                });
              }
            }

      # CASE 2a: SUCCESS -> Merge to Main
      - name: Merge Dev to Main
        if: steps.run-tests.outcome == 'success'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          git checkout main
          git merge dev
          git push origin main
